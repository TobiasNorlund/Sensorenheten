/*
 * gyro.c
 *
 * Created: 4/16/2013 9:48:15 AM
 *  Author: johka546
 */
#include "gyro.h"
int8_t lookUpGyro[255] = {
	
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-500,
	-301,
	-298,
	-296,
	-293,
	-290,
	-288,
	-285,
	-282,
	-280,
	-277,
	-274,
	-272,
	-269,
	-266,
	-264,
	-261,
	-259,
	-256,
	-253,
	-251,
	-248,
	-245,
	-243,
	-240,
	-237,
	-235,
	-232,
	-229,
	-227,
	-224,
	-221,
	-219,
	-216,
	-214,
	-211,
	-208,
	-206,
	-203,
	-200,
	-198,
	-195,
	-192,
	-190,
	-187,
	-184,
	-182,
	-179,
	-176,
	-174,
	-171,
	-169,
	-166,
	-163,
	-161,
	-158,
	-155,
	-153,
	-150,
	-147,
	-145,
	-142,
	-139,
	-137,
	-134,
	-131,
	-129,
	-126,
	-124,
	-121,
	-118,
	-116,
	-113,
	-110,
	-108,
	-105,
	-102,
	-100,
	-97,
	-94,
	-92,
	-89,
	-86,
	-84,
	-81,
	-79,
	-76,
	-73,
	-71,
	-68,
	-65,
	-63,
	-60,
	-57,
	-55,
	-52,
	-49,
	-47,
	-44,
	-41,
	-39,
	-36,
	-34,
	-31,
	-28,
	-26,
	-23,
	-20,
	-18,
	-15,
	-12,
	-10,
	-7,
	-4,
	-2,
	1,
	4,
	6,
	9,
	11,
	14,
	17,
	19,
	22,
	25,
	27,
	30,
	33,
	35,
	38,
	41,
	43,
	46,
	49,
	51,
	54,
	56,
	59,
	62,
	64,
	67,
	70,
	72,
	75,
	78,
	80,
	83,
	86,
	88,
	91,
	94,
	96,
	99,
	101,
	104,
	107,
	109,
	112,
	115,
	117,
	120,
	123,
	125,
	128,
	131,
	133,
	136,
	139,
	141,
	144,
	146,
	149,
	152,
	154,
	157,
	160,
	162,
	165,
	168,
	170,
	173,
	176,
	178,
	181,
	184,
	186,
	189,
	191,
	194,
	197,
	199,
	202,
	205,
	207,
	210,
	213,
	215,
	218,
	221,
	223,
	226,
	229,
	231,
	234,
	236,
	239,
	242,
	244,
	247,
	250,
	252,
	255,
	258,
	260,
	263,
	266,
	268,
	271,
	274,
	276,
	279,
	281,
	284,
	287,
	289,
	292,
	295,
	297,
	300,
};
 
void Init_gyro(void)
{
	//timed interupt init
	TIMSK0 = (1<<OCIE0A);// Enable Interrupt TimerCounter0 Compare Match A (SIG_OUTPUT_COMPARE0A)
	TCCR0A = (1<<WGM01); // Mode = CTC, clear on compare, dvs reseta räknaren
	TCCR0B = (1<<CS02)|(0<<CS01)|(1<<CS00);// Clock/1024, 0.000128 seconds per tick
	OCR0A = 0.02f/0.000128f; // 0.2f/0.000128f ger 50 gånger i sekunden 1/50= 0.02
	currentGyroCell = 0;
	//end timed interupt init																											
}

uint16_t gyroLookUp(uint16_t sample)
{
	return lookUpGyro[(sample>>8)];//TODO
}

//timed interup
ISR(TIMER0_COMPA_vect)
{
	//gyro data
	uint8_t receivedData1;
	uint8_t receivedData2;

	MSPI_SS_LOW;
	MSPI_exchange(0b10010100);
	receivedData1=MSPI_exchange(0b00000000);
	receivedData2=MSPI_exchange(0b00000000);
	
	MSPI_exchange(0b10010100);
	receivedData1=MSPI_exchange(0b00000000);
	receivedData2=MSPI_exchange(0b00000000);
	
	
	MSPI_exchange(0b10000000);
	receivedData1=MSPI_exchange(0b00000000);
	receivedData2=MSPI_exchange(0b00000000);
	MSPI_SS_HIGH;
	
	currentGyroCell++;
	if(NUMGYROSAMPLES<=currentGyroCell)
	{
		currentGyroCell=0;
	}
	gyroData[currentGyroCell]=(((uint16_t)receivedData1)<<8)|(uint16_t)receivedData2;

}