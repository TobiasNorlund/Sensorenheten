/*
 * gyro.c
 *
 * Created: 4/16/2013 9:48:15 AM
 *  Author: johka546
 */
#include "gyro.h"
int8_t lookUpGyro[1024] = {
500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,500
,-300
,-299
,-299
,-298
,-297
,-297
,-296
,-295
,-295
,-294
,-293
,-293
,-292
,-291
,-291
,-290
,-289
,-289
,-288
,-287
,-287
,-286
,-285
,-285
,-284
,-283
,-283
,-282
,-281
,-281
,-280
,-279
,-279
,-278
,-277
,-277
,-276
,-275
,-275
,-274
,-273
,-273
,-272
,-272
,-271
,-270
,-270
,-269
,-268
,-268
,-267
,-266
,-266
,-265
,-264
,-264
,-263
,-262
,-262
,-261
,-260
,-260
,-259
,-258
,-258
,-257
,-256
,-256
,-255
,-254
,-254
,-253
,-252
,-252
,-251
,-250
,-250
,-249
,-248
,-248
,-247
,-246
,-246
,-245
,-244
,-244
,-243
,-243
,-242
,-241
,-241
,-240
,-239
,-239
,-238
,-237
,-237
,-236
,-235
,-235
,-234
,-233
,-233
,-232
,-231
,-231
,-230
,-229
,-229
,-228
,-227
,-227
,-226
,-225
,-225
,-224
,-223
,-223
,-222
,-221
,-221
,-220
,-219
,-219
,-218
,-217
,-217
,-216
,-215
,-215
,-214
,-214
,-213
,-212
,-212
,-211
,-210
,-210
,-209
,-208
,-208
,-207
,-206
,-206
,-205
,-204
,-204
,-203
,-202
,-202
,-201
,-200
,-200
,-199
,-198
,-198
,-197
,-196
,-196
,-195
,-194
,-194
,-193
,-192
,-192
,-191
,-190
,-190
,-189
,-188
,-188
,-187
,-186
,-186
,-185
,-184
,-184
,-183
,-183
,-182
,-181
,-181
,-180
,-179
,-179
,-178
,-177
,-177
,-176
,-175
,-175
,-174
,-173
,-173
,-172
,-171
,-171
,-170
,-169
,-169
,-168
,-167
,-167
,-166
,-165
,-165
,-164
,-163
,-163
,-162
,-161
,-161
,-160
,-159
,-159
,-158
,-157
,-157
,-156
,-155
,-155
,-154
,-154
,-153
,-152
,-152
,-151
,-150
,-150
,-149
,-148
,-148
,-147
,-146
,-146
,-145
,-144
,-144
,-143
,-142
,-142
,-141
,-140
,-140
,-139
,-138
,-138
,-137
,-136
,-136
,-135
,-134
,-134
,-133
,-132
,-132
,-131
,-130
,-130
,-129
,-128
,-128
,-127
,-126
,-126
,-125
,-125
,-124
,-123
,-123
,-122
,-121
,-121
,-120
,-119
,-119
,-118
,-117
,-117
,-116
,-115
,-115
,-114
,-113
,-113
,-112
,-111
,-111
,-110
,-109
,-109
,-108
,-107
,-107
,-106
,-105
,-105
,-104
,-103
,-103
,-102
,-101
,-101
,-100
,-99
,-99
,-98
,-97
,-97
,-96
,-96
,-95
,-94
,-94
,-93
,-92
,-92
,-91
,-90
,-90
,-89
,-88
,-88
,-87
,-86
,-86
,-85
,-84
,-84
,-83
,-82
,-82
,-81
,-80
,-80
,-79
,-78
,-78
,-77
,-76
,-76
,-75
,-74
,-74
,-73
,-72
,-72
,-71
,-70
,-70
,-69
,-68
,-68
,-67
,-67
,-66
,-65
,-65
,-64
,-63
,-63
,-62
,-61
,-61
,-60
,-59
,-59
,-58
,-57
,-57
,-56
,-55
,-55
,-54
,-53
,-53
,-52
,-51
,-51
,-50
,-49
,-49
,-48
,-47
,-47
,-46
,-45
,-45
,-44
,-43
,-43
,-42
,-41
,-41
,-40
,-39
,-39
,-38
,-38
,-37
,-36
,-36
,-35
,-34
,-34
,-33
,-32
,-32
,-31
,-30
,-30
,-29
,-28
,-28
,-27
,-26
,-26
,-25
,-24
,-24
,-23
,-22
,-22
,-21
,-20
,-20
,-19
,-18
,-18
,-17
,-16
,-16
,-15
,-14
,-14
,-13
,-12
,-12
,-11
,-10
,-10
,-9
,-8
,-8
,-7
,-7
,-6
,-5
,-5
,-4
,-3
,-3
,-2
,-1
,-1
,0
,1
,1
,2
,3
,3
,4
,5
,5
,6
,7
,7
,8
,9
,9
,10
,11
,11
,12
,13
,13
,14
,15
,15
,16
,17
,17
,18
,19
,19
,20
,21
,21
,22
,22
,23
,24
,24
,25
,26
,26
,27
,28
,28
,29
,30
,30
,31
,32
,32
,33
,34
,34
,35
,36
,36
,37
,38
,38
,39
,40
,40
,41
,42
,42
,43
,44
,44
,45
,46
,46
,47
,48
,48
,49
,50
,50
,51
,51
,52
,53
,53
,54
,55
,55
,56
,57
,57
,58
,59
,59
,60
,61
,61
,62
,63
,63
,64
,65
,65
,66
,67
,67
,68
,69
,69
,70
,71
,71
,72
,73
,73
,74
,75
,75
,76
,77
,77
,78
,79
,79
,80
,80
,81
,82
,82
,83
,84
,84
,85
,86
,86
,87
,88
,88
,89
,90
,90
,91
,92
,92
,93
,94
,94
,95
,96
,96
,97
,98
,98
,99
,100
,100
,101
,102
,102
,103
,104
,104
,105
,106
,106
,107
,108
,108
,109
,109
,110
,111
,111
,112
,113
,113
,114
,115
,115
,116
,117
,117
,118
,119
,119
,120
,121
,121
,122
,123
,123
,124
,125
,125
,126
,127
,127
,128
,129
,129
,130
,131
,131
,132
,133
,133
,134
,135
,135
,136
,137
,137
,138
,139
,139
,140
,140
,141
,142
,142
,143
,144
,144
,145
,146
,146
,147
,148
,148
,149
,150
,150
,151
,152
,152
,153
,154
,154
,155
,156
,156
,157
,158
,158
,159
,160
,160
,161
,162
,162
,163
,164
,164
,165
,166
,166
,167
,168
,168
,169
,169
,170
,171
,171
,172
,173
,173
,174
,175
,175
,176
,177
,177
,178
,179
,179
,180
,181
,181
,182
,183
,183
,184
,185
,185
,186
,187
,187
,188
,189
,189
,190
,191
,191
,192
,193
,193
,194
,195
,195
,196
,197
,197
,198
,198
,199
,200
,200
,201
,202
,202
,203
,204
,204
,205
,206
,206
,207
,208
,208
,209
,210
,210
,211
,212
,212
,213
,214
,214
,215
,216
,216
,217
,218
,218
,219
,220
,220
,221
,222
,222
,223
,224
,224
,225
,226
,226
,227
,227
,228
,229
,229
,230
,231
,231
,232
,233
,233
,234
,235
,235
,236
,237
,237
,238
,239
,239
,240
,241
,241
,242
,243
,243
,244
,245
,245
,246
,247
,247
,248
,249
,249
,250
,251
,251
,252
,253
,253
,254
,255
,255
,256
,256
,257
,258
,258
,259
,260
,260
,261
,262
,262
,263
,264
,264
,265
,266
,266
,267
,268
,268
,269
,270
,270
,271
,272
,272
,273
,274
,274
,275
,276
,276
,277
,278
,278
,279
,280
,280
,281
,282
,282
,283
,284
,284
,285
,285
,286
,287
,287
,288
,289
,289
,290
,291
,291
,292
,293
,293
,294
,295
,295
,296
,297
,297
,298
,299
,299
};
 
void Init_gyro(void)
{
	//timed interupt init
	TIMSK0 = (1<<OCIE0A);// Enable Interrupt TimerCounter0 Compare Match A (SIG_OUTPUT_COMPARE0A)
	TCCR0A = (1<<WGM01); // Mode = CTC, clear on compare, dvs reseta räknaren
	TCCR0B = (1<<CS02)|(0<<CS01)|(1<<CS00);// Clock/1024, 0.000128 seconds per tick
	OCR0A = 0.02f/0.000128f; // 0.2f/0.000128f ger 50 gånger i sekunden 1/50= 0.02
	currentGyroCell = 0;
	//end timed interupt init																											
}

uint16_t gyroLookUp(uint16_t sample)
{
	return lookUpGyro[sample];
}

//timed interup
ISR(TIMER0_COMPA_vect)
{
	//gyro data
	uint8_t receivedData1;
	uint8_t receivedData2;

	MSPI_SS_LOW;
	MSPI_exchange(0b10010100);
	receivedData1=MSPI_exchange(0b00000000);
	receivedData2=MSPI_exchange(0b00000000);
	
	MSPI_exchange(0b10010100);
	receivedData1=MSPI_exchange(0b00000000);
	receivedData2=MSPI_exchange(0b00000000);
	_delay_us(130);//Instead of the polling of the EOC bit one can use a simple delay that should be bigger than a maximal conversion time (>115 µs, see table 4). 
	MSPI_exchange(0b10000000);
	receivedData1=MSPI_exchange(0b00000000);
	receivedData2=MSPI_exchange(0b00000000);
	MSPI_SS_HIGH;
	if(receivedData1&0b00100000)//om (EOC) is zero, the conversion is still in progress and the result of the conversion (bits AD10…AD0) is not valid.
	{
		receivedData1=0b00001111&receivedData1;
			
		currentGyroCell++;
		if(NUMGYROSAMPLES<=currentGyroCell)
		{
			currentGyroCell=0;
		}
		gyroData[currentGyroCell]=((((uint16_t)receivedData1)<<8)|(uint16_t)receivedData2)>>2;
	}
}